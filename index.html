<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Presentes - Eduardo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #2c3e50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        select, input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .item-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .item-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .item-details {
            padding: 15px;
        }
        
        .item-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .item-price {
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 10px;
        }
        
        .item-category {
            display: inline-block;
            background-color: #ecf0f1;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }
        
        .item-work {
            display: inline-block;
            background-color: #d5dbdb;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-bottom: 10px;
            margin-left: 5px;
        }
        
        .item-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .item-link-container {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .item-link {
            color: #3498db;
            text-decoration: none;
            font-weight: bold;
        }
        
        .item-link:hover {
            text-decoration: underline;
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }
        
        .action-buttons button {
            flex: 1;
            min-width: 120px;
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .purchase-btn {
            background-color: #27ae60;
        }
        
        .purchase-btn:hover {
            background-color: #219653;
        }
        
        .edit-btn {
            background-color: #f39c12;
        }
        
        .edit-btn:hover {
            background-color: #e67e22;
        }
        
        .delete-btn {
            background-color: #e74c3c;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        .comprado {
            opacity: 0.7;
            position: relative;
        }
        
        .comprado::after {
            content: "COMPRADO";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            background-color: rgba(231, 76, 60, 0.8);
            color: white;
            padding: 5px 15px;
            font-weight: bold;
            font-size: 1.2rem;
            border-radius: 4px;
        }
        
        .total {
            margin-top: 30px;
            text-align: right;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        .manga-filter {
            margin-top: 10px;
        }
        
        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .popup-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .popup-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* NOVOS ESTILOS PARA COMPARTILHAMENTO */
        .share-section {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .share-section h3 {
            margin-bottom: 15px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .share-url-container {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .share-url {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }
        
        .share-url::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .copy-btn {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .share-info {
            margin-top: 15px;
            text-align: left;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .share-info p {
            margin: 8px 0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Estilos para mensagens */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            color: white;
            font-weight: bold;
        }
        
        .message.success {
            background: #2ecc71;
        }
        
        .message.warning {
            background: #f39c12;
        }
        
        .message.error {
            background: #e74c3c;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .filters {
                justify-content: center;
            }
            
            .items-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons button {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .share-url-container {
                flex-direction: column;
            }
            
            .share-section {
                padding: 15px;
            }
            
            .share-info p {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Lista de Presentes para Eduardo</h1>
            <p>Gerencie os presentes que voc√™ deseja comprar</p>
        </header>
        
        <div class="controls">
            <div>
                <div class="filters">
                    <select id="categoryFilter">
                        <option value="">Todas as categorias</option>
                    </select>
                    <select id="statusFilter">
                        <option value="todos">Todos os itens</option>
                        <option value="disponiveis">Dispon√≠veis</option>
                        <option value="comprados">Comprados</option>
                    </select>
                    <input type="text" id="searchInput" placeholder="Pesquisar por nome...">
                </div>
                <div class="manga-filter hidden" id="mangaFilterContainer">
                    <select id="mangaFilter">
                        <option value="">Todos os mang√°s</option>
                    </select>
                </div>
            </div>
            <button id="addItemBtn">Adicionar Item</button>
        </div>
        
        <div class="items-grid" id="itemsContainer">
            <!-- Itens ser√£o inseridos aqui via JavaScript -->
        </div>
        
        <div class="total">
            Total estimado: R$ <span id="totalValue">0</span>
        </div>
        
        <!-- NOVA SE√á√ÉO: Compartilhamento -->
        <div class="share-section">
            <h3>üì§ Compartilhar Lista</h3>
            <p>Copie o link abaixo para compartilhar sua lista atualizada:</p>
            <div class="share-url-container">
                <input type="text" class="share-url" id="shareUrl" readonly>
                <button class="copy-btn" id="copyBtn">üìã Copiar</button>
            </div>
            <div class="share-info">
                <p>‚úÖ <strong>Este link cont√©m todos os itens da sua lista</strong></p>
                <p>üîó <strong>Como usar:</strong> Envie este link para amigos/fam√≠lia</p>
                <p>‚ö†Ô∏è <strong>Limita√ß√£o:</strong> O link pode ficar muito longo com muitos itens</p>
            </div>
        </div>
    </div>
    
    <!-- Modal para adicionar/editar itens -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <h2 id="modalTitle">Adicionar Novo Item</h2>
            <form id="itemForm">
                <div class="form-group">
                    <label for="itemName">Nome do Produto</label>
                    <input type="text" id="itemName" required>
                </div>
                <div class="form-group">
                    <label for="itemPrice">Pre√ßo (R$)</label>
                    <input type="number" id="itemPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="itemCategory">Categoria</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="itemCategory" required style="flex: 1;">
                            <option value="">Selecione uma categoria</option>
                        </select>
                        <button type="button" id="addCategoryBtn" style="white-space: nowrap;">+ Nova</button>
                    </div>
                </div>
                <div class="form-group hidden" id="workGroup">
                    <label for="itemWork">Obra (para mang√°s)</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="itemWork" style="flex: 1;">
                            <option value="">Selecione um mang√°</option>
                        </select>
                        <button type="button" id="addMangaBtn" style="white-space: nowrap;">+ Novo</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="itemPlatform">Plataforma</label>
                    <input type="text" id="itemPlatform">
                </div>
                <div class="form-group">
                    <label for="itemLink">Link</label>
                    <input type="url" id="itemLink">
                </div>
                <div class="form-group">
                    <label for="itemImage">URL da Imagem</label>
                    <input type="url" id="itemImage">
                </div>
                <div class="form-group">
                    <label for="itemNotes">Observa√ß√µes</label>
                    <textarea id="itemNotes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancelBtn">Cancelar</button>
                    <button type="submit" id="saveBtn">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Popups para adicionar categoria e mang√° -->
    <div class="popup" id="categoryPopup">
        <div class="popup-content">
            <h3>Adicionar Nova Categoria</h3>
            <div class="form-group">
                <input type="text" id="newCategoryName" placeholder="Ex: Action Figures, Funko Pop, etc.">
            </div>
            <div class="popup-actions">
                <button type="button" id="cancelCategoryBtn">Cancelar</button>
                <button type="button" id="saveCategoryBtn">Salvar</button>
            </div>
        </div>
    </div>
    
    <div class="popup" id="mangaPopup">
        <div class="popup-content">
            <h3>Adicionar Novo Mang√°</h3>
            <div class="form-group">
                <input type="text" id="newMangaName" placeholder="Ex: Attack on Titan, One Piece, etc.">
            </div>
            <div class="popup-actions">
                <button type="button" id="cancelMangaBtn">Cancelar</button>
                <button type="button" id="saveMangaBtn">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        // ===== DADOS INICIAIS =====
        const initialItems = [
            {
                id: 1,
                name: "Mang√° Ataque dos tit√£s 2 em 1 vol.1",
                price: 45,
                category: "Mang√°s",
                work: "Ataque dos Tit√£s",
                platform: "Amazon",
                link: "https://www.amazon.com.br/gp/product/6525905265/ref=ewc_pr_img_1?smid=A1ZZFT5FULY4LN&psc=1",
                image: "",
                notes: "Sem categoria explicita",
                purchased: false
            },
            {
                id: 2,
                name: "Mang√° 20th Century Boys Definitive Edition vol.1",
                price: 60,
                category: "Mang√°s",
                work: "20th Century Boys",
                platform: "Amazon",
                link: "https://www.amazon.com.br/gp/product/6525933110/ref=ewc_pr_img_4?smid=A1ZZFT5FULY4LN&psc=1",
                image: "",
                notes: "Boneco/Action Figure",
                purchased: false
            },
            {
                id: 3,
                name: "Apoio para pulso redragon infernal",
                price: 50,
                category: "Acess√≥rios",
                platform: "Amazon",
                link: "https://www.amazon.com.br/Teclado-Redragon-ID023-Infernal-Dragon/dp/B091Q8T556/ref=pd_ci_mcx_mh_mcx_views_0_title",
                image: "",
                notes: "",
                purchased: false
            },
            {
                id: 4,
                name: "Rel√≥gio Casio Vintage A138",
                price: 200,
                category: "Acess√≥rios",
                platform: "Mercado livre",
                link: "https://produto.mercadolivre.com.br/MLB-4165923599-relogio-casio-vintage-a138-edico-limitada-original-preto-_JM?attributes=BEZEL_COLOR%3AUHJldG8%3D%2CSTRAP_COLOR%3AUHJldG8%3D&quantity=1&picker=true",
                image: "",
                notes: "",
                purchased: false
            }
        ];

        const predefinedMangas = [
            "Ataque dos Tit√£s", "20th Century Boys", "A Voz do Sil√™ncio", 
            "The Promised Neverland", "Oshi no Ko", "One Piece", 
            "Naruto", "Dragon Ball", "Death Note", "Berserk"
        ];

        // ===== VARI√ÅVEIS GLOBAIS =====
        let items = [];
        let categories = [];
        let mangas = [];
        let editingItemId = null;

        // ===== ELEMENTOS DOM =====
        const itemsContainer = document.getElementById('itemsContainer');
        const categoryFilter = document.getElementById('categoryFilter');
        const statusFilter = document.getElementById('statusFilter');
        const searchInput = document.getElementById('searchInput');
        const mangaFilterContainer = document.getElementById('mangaFilterContainer');
        const mangaFilter = document.getElementById('mangaFilter');
        const addItemBtn = document.getElementById('addItemBtn');
        const itemModal = document.getElementById('itemModal');
        const modalTitle = document.getElementById('modalTitle');
        const itemForm = document.getElementById('itemForm');
        const cancelBtn = document.getElementById('cancelBtn');
        const itemCategory = document.getElementById('itemCategory');
        const workGroup = document.getElementById('workGroup');
        const itemWork = document.getElementById('itemWork');
        const totalValue = document.getElementById('totalValue');
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        const addMangaBtn = document.getElementById('addMangaBtn');
        const categoryPopup = document.getElementById('categoryPopup');
        const mangaPopup = document.getElementById('mangaPopup');
        const newCategoryName = document.getElementById('newCategoryName');
        const newMangaName = document.getElementById('newMangaName');
        const cancelCategoryBtn = document.getElementById('cancelCategoryBtn');
        const saveCategoryBtn = document.getElementById('saveCategoryBtn');
        const cancelMangaBtn = document.getElementById('cancelMangaBtn');
        const saveMangaBtn = document.getElementById('saveMangaBtn');
        const shareUrl = document.getElementById('shareUrl');
        const copyBtn = document.getElementById('copyBtn');

        // ===== GERENCIADOR DE COMPARTILHAMENTO =====
        class ShareManager {
            constructor() {
                this.shareUrlElement = document.getElementById('shareUrl');
                this.copyBtn = document.getElementById('copyBtn');
                this.init();
            }

            init() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                this.copyBtn.addEventListener('click', () => this.copyShareUrl());
            }

            encodeData(data) {
                try {
                    const jsonString = JSON.stringify(data);
                    const compressed = jsonString.replace(/\s+/g, ' ');
                    return btoa(compressed);
                } catch (error) {
                    console.error('Erro ao codificar dados:', error);
                    return null;
                }
            }

            decodeData(encodedData) {
                try {
                    const decoded = atob(encodedData);
                    return JSON.parse(decoded);
                } catch (error) {
                    console.error('Erro ao decodificar dados:', error);
                    return null;
                }
            }

            hasSharedData() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.has('data');
            }

            loadDataFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                const encodedData = urlParams.get('data');
                
                if (encodedData) {
                    const data = this.decodeData(encodedData);
                    if (data && this.validateData(data)) {
                        return data;
                    }
                }
                return null;
            }

            validateData(data) {
                return data.items && Array.isArray(data.items);
            }

            updateShareUrl() {
                const data = {
                    items: items,
                    categories: categories,
                    mangas: mangas,
                    timestamp: new Date().getTime(),
                    version: '1.0'
                };
                
                const encodedData = this.encodeData(data);
                if (encodedData) {
                    const shareUrl = this.generateShareUrl(encodedData);
                    this.shareUrlElement.value = shareUrl;
                    this.updateBrowserUrl(encodedData);
                }
            }

            generateShareUrl(encodedData) {
                return window.location.origin + window.location.pathname + '?data=' + encodedData;
            }

            updateBrowserUrl(encodedData) {
                const newUrl = window.location.origin + window.location.pathname + '?data=' + encodedData;
                window.history.replaceState({ path: newUrl }, '', newUrl);
            }

            async copyShareUrl() {
                try {
                    await navigator.clipboard.writeText(this.shareUrlElement.value);
                    this.showMessage('‚úÖ Link copiado para a √°rea de transfer√™ncia!', 'success');
                    
                    this.copyBtn.textContent = '‚úÖ Copiado!';
                    setTimeout(() => {
                        this.copyBtn.textContent = 'üìã Copiar';
                    }, 2000);
                    
                } catch (err) {
                    this.fallbackCopy();
                }
            }

            fallbackCopy() {
                this.shareUrlElement.select();
                this.shareUrlElement.setSelectionRange(0, 99999);
                document.execCommand('copy');
                this.showMessage('‚úÖ Link copiado!', 'success');
            }

            showMessage(text, type = 'success') {
                const messageEl = document.createElement('div');
                messageEl.textContent = text;
                messageEl.className = `message ${type}`;
                
                document.body.appendChild(messageEl);
                
                setTimeout(() => {
                    messageEl.remove();
                }, 3000);
            }
        }

        // ===== FUN√á√ïES PRINCIPAIS =====
        const shareManager = new ShareManager();

        function initializeApp() {
            const sharedData = shareManager.loadDataFromUrl();
            
            if (sharedData) {
                items = sharedData.items;
                categories = sharedData.categories || [];
                mangas = sharedData.mangas || [];
                shareManager.showMessage('‚úÖ Lista carregada do link compartilhado!', 'success');
            } else {
                items = JSON.parse(localStorage.getItem('giftItems')) || initialItems;
                categories = JSON.parse(localStorage.getItem('categoryList')) || [...new Set(initialItems.map(item => item.category))];
                mangas = JSON.parse(localStorage.getItem('mangaList')) || predefinedMangas;
            }
            
            renderItems();
            populateCategoryFilters();
            populateMangaFilters();
            updateTotalValue();
            shareManager.updateShareUrl();
        }

        function renderItems() {
            const category = categoryFilter.value;
            const status = statusFilter.value;
            const searchTerm = searchInput.value.toLowerCase();
            const manga = mangaFilter.value;
            
            let filteredItems = items.filter(item => {
                const matchesCategory = category === '' || item.category === category;
                const matchesStatus = 
                    status === 'todos' || 
                    (status === 'disponiveis' && !item.purchased) ||
                    (status === 'comprados' && item.purchased);
                const matchesSearch = 
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.work && item.work.toLowerCase().includes(searchTerm)) ||
                    item.category.toLowerCase().includes(searchTerm) ||
                    (item.notes && item.notes.toLowerCase().includes(searchTerm));
                const matchesManga = manga === '' || item.work === manga;
                
                return matchesCategory && matchesStatus && matchesSearch && matchesManga;
            });
            
            itemsContainer.innerHTML = '';
            
            filteredItems.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = `item-card ${item.purchased ? 'comprado' : ''}`;
                
                itemCard.innerHTML = `
                    ${item.image ? `<img src="${item.image}" alt="${item.name}" class="item-image">` : 
                      `<div class="item-image" style="background-color: #ecf0f1; display: flex; align-items: center; justify-content: center;">
                         <span>Sem imagem</span>
                       </div>`}
                    <div class="item-details">
                        <h3 class="item-title">${item.name}</h3>
                        <div class="item-price">R$ ${item.price.toFixed(2)}</div>
                        <div>
                            <span class="item-category">${item.category}</span>
                            ${item.work ? `<span class="item-work">${item.work}</span>` : ''}
                        </div>
                        <p>${item.platform ? `Plataforma: ${item.platform}` : ''}</p>
                        ${item.notes ? `<p>${item.notes}</p>` : ''}
                        <div class="item-actions">
                            <div class="item-link-container">
                                ${item.link ? `<a href="${item.link}" target="_blank" class="item-link">Ver produto</a>` : 
                                              `<span>Sem link</span>`}
                            </div>
                            <div class="action-buttons">
                                <button onclick="togglePurchase(${item.id})" class="purchase-btn">
                                    ${item.purchased ? 'Desmarcar' : 'Marcar como comprado'}
                                </button>
                                <button onclick="editItem(${item.id})" class="edit-btn">Editar</button>
                                <button onclick="deleteItem(${item.id})" class="delete-btn">Excluir</button>
                            </div>
                        </div>
                    </div>
                `;
                
                itemsContainer.appendChild(itemCard);
            });
        }

        function populateCategoryFilters() {
            categoryFilter.innerHTML = '<option value="">Todas as categorias</option>';
            itemCategory.innerHTML = '<option value="">Selecione uma categoria</option>';
            
            categories.forEach(category => {
                const option1 = document.createElement('option');
                option1.value = category;
                option1.textContent = category;
                categoryFilter.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = category;
                option2.textContent = category;
                itemCategory.appendChild(option2);
            });
        }

        function populateMangaFilters() {
            mangaFilter.innerHTML = '<option value="">Todos os mang√°s</option>';
            itemWork.innerHTML = '<option value="">Selecione um mang√°</option>';
            
            mangas.forEach(manga => {
                const option1 = document.createElement('option');
                option1.value = manga;
                option1.textContent = manga;
                mangaFilter.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = manga;
                option2.textContent = manga;
                itemWork.appendChild(option2);
            });
        }

        function handleCategoryFilterChange() {
            if (this.value === 'Mang√°s') {
                mangaFilterContainer.classList.remove('hidden');
            } else {
                mangaFilterContainer.classList.add('hidden');
                mangaFilter.value = '';
            }
            renderItems();
        }

        function openAddModal() {
            editingItemId = null;
            modalTitle.textContent = 'Adicionar Novo Item';
            itemForm.reset();
            workGroup.classList.add('hidden');
            itemModal.style.display = 'flex';
        }

        function closeModal() {
            itemModal.style.display = 'none';
            editingItemId = null;
        }

        function saveItem(e) {
            e.preventDefault();
            
            const name = document.getElementById('itemName').value;
            const price = parseFloat(document.getElementById('itemPrice').value);
            const category = document.getElementById('itemCategory').value;
            const work = document.getElementById('itemWork').value;
            const platform = document.getElementById('itemPlatform').value;
            const link = document.getElementById('itemLink').value;
            const image = document.getElementById('itemImage').value;
            const notes = document.getElementById('itemNotes').value;
            
            if (editingItemId) {
                const index = items.findIndex(item => item.id === editingItemId);
                if (index !== -1) {
                    items[index] = {
                        ...items[index],
                        name,
                        price,
                        category,
                        work: category === 'Mang√°s' ? work : '',
                        platform,
                        link,
                        image,
                        notes
                    };
                }
            } else {
                const newItem = {
                    id: Date.now(),
                    name,
                    price,
                    category,
                    work: category === 'Mang√°s' ? work : '',
                    platform,
                    link,
                    image,
                    notes,
                    purchased: false
                };
                
                items.push(newItem);
            }
            
            saveToLocalStorage();
            shareManager.updateShareUrl();
            renderItems();
            updateTotalValue();
            closeModal();
        }

        function editItem(id) {
            const item = items.find(item => item.id === id);
            if (!item) return;
            
            editingItemId = id;
            modalTitle.textContent = 'Editar Item';
            
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemPlatform').value = item.platform || '';
            document.getElementById('itemLink').value = item.link || '';
            document.getElementById('itemImage').value = item.image || '';
            document.getElementById('itemNotes').value = item.notes || '';
            
            if (item.category === 'Mang√°s') {
                workGroup.classList.remove('hidden');
                document.getElementById('itemWork').value = item.work || '';
            } else {
                workGroup.classList.add('hidden');
            }
            
            itemModal.style.display = 'flex';
        }

        function deleteItem(id) {
            if (confirm('Tem certeza que deseja excluir este item?')) {
                items = items.filter(item => item.id !== id);
                saveToLocalStorage();
                shareManager.updateShareUrl();
                renderItems();
                updateTotalValue();
            }
        }

        function togglePurchase(id) {
            const item = items.find(item => item.id === id);
            if (item) {
                item.purchased = !item.purchased;
                saveToLocalStorage();
                shareManager.updateShareUrl();
                renderItems();
                updateTotalValue();
            }
        }

        function updateTotalValue() {
            const total = items
                .filter(item => !item.purchased)
                .reduce((sum, item) => sum + item.price, 0);
            
            totalValue.textContent = total.toFixed(2);
        }

        function saveToLocalStorage() {
            localStorage.setItem('giftItems', JSON.stringify(items));
            localStorage.setItem('categoryList', JSON.stringify(categories));
            localStorage.setItem('mangaList', JSON.stringify(mangas));
        }

        function openCategoryPopup() {
            newCategoryName.value = '';
            categoryPopup.style.display = 'flex';
        }
        
        function closeCategoryPopup() {
            categoryPopup.style.display = 'none';
        }
        
        function saveNewCategory() {
            const categoryName = newCategoryName.value.trim();
            if (categoryName && !categories.includes(categoryName)) {
                categories.push(categoryName);
                saveToLocalStorage();
                populateCategoryFilters();
                itemCategory.value = categoryName;
                closeCategoryPopup();
                shareManager.updateShareUrl();
            } else if (categories.includes(categoryName)) {
                shareManager.showMessage('‚ö†Ô∏è Esta categoria j√° existe!', 'warning');
            }
        }
        
        function openMangaPopup() {
            newMangaName.value = '';
            mangaPopup.style.display = 'flex';
        }
        
        function closeMangaPopup() {
            mangaPopup.style.display = 'none';
        }
        
        function saveNewManga() {
            const mangaName = newMangaName.value.trim();
            if (mangaName && !mangas.includes(mangaName)) {
                mangas.push(mangaName);
                saveToLocalStorage();
                populateMangaFilters();
                itemWork.value = mangaName;
                closeMangaPopup();
                shareManager.updateShareUrl();
            } else if (mangas.includes(mangaName)) {
                shareManager.showMessage('‚ö†Ô∏è Este mang√° j√° existe!', 'warning');
            }
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', initializeApp);

        addItemBtn.addEventListener('click', openAddModal);
        cancelBtn.addEventListener('click', closeModal);
        itemForm.addEventListener('submit', saveItem);
        categoryFilter
